---
title: JavaScript中的内存管理与常见的内存泄漏处理方法-笔记
date: 2017-09-18 18:55:43
tags:
- JavaScript
- Memory
---

{% blockquote Alexander Zlatkov 
https://blog.sessionstack.com/how-javascript-works-memory-management-how-to-handle-4-common-memory-leaks-3f28b94cfbec %}
阅读《How JavaScript works: memory management + how to handle 4 common memory leaks》文章笔记
{% endblockquote %}

常见的编程语言，例如C/C++这些低级编程语言是由编程人员自己手动管理内存的，例如常见的内存分配```malloc```和内存释放```free```。程序员可以使用这些语法来向操作系统请求或者释放掉内存。

<!--more-->

其他高级编程语言，例如Java/JavaScript，在语言层面上做了自动的内存管理，无须程序编写人员手动的编写内存管理。JavaScript中有个单独的垃圾回收进程，在变量，对象，字符串等呗创建时动态的分配内存，并且在这些变量，对象或字符串不再被使用之后释放他们。自动的过程简化了内存管理的过程，使得程序员不需要过分关心内存的分配情况，同时避免了不靠谱的内存操作。但是同时很多人完全忽略掉了内存管理这个问题。

内存管理一直是一大难题，有一本关于垃圾回收的书很有名，有空可以阅读下：
{% blockquote [日] 中村成洋，相川光 著；丁灵 译；竹内郁雄 校 https://item.jd.com/12010270.html%}
《垃圾回收的算法与实现》
{% endblockquote %}

回到正题，自动内存管理并不是很智能的，它可以handle住大多数的情况，但是总有些意料之外的问题，并且这些意料之外的问题大多是由于编写人员部署需内存机制导致的。

### 内存生命周期

无论哪种编程语言，都有一个类似生命周期过程：

内存分配 -> 内存使用 -> 内存释放，

三个生命周期的过程大概如下：

1. 内存分配： 操作系统分配内存空间出来给编程语言使用，如上所述，低级语言如C/C++，需要手动的申请内存，而在高级语言中，一切都是自动的。
2. 内存使用： 这个阶段是编程语言运行时使用内存的阶段，运行时使用这些内存进行读写操作
3. 内存释放： 当不再需要某些内存对象时，便可以释放它，这一部分内存空间会被操作系统回收，并可用做下次内存分配。

### 什么是内存

硬件层面上，内存是大量的晶体管构成的组合体，多个晶体管组合成flip flops，每个flip flops由一个特殊的标识符做索引，用于寻址，从而可以内存寻址，并且可以复写或者读取flip flops上的内容。

一个晶体管可以存储1bit，8个bit为一个byte，根据不同的操作系统和硬件平台，16/32个bit可以组成一个word。在一个程序由开始到结束的过程中，几乎所有的东西都需要和内存相关。所有的变量和程序中使用的数据需要存储到内存中，所有的程序代码。包括操作系统本身也需要装载至系统中。

当编译器编译代码时，编译器会提前估算出程序中所有的原始数据类型所需要的内存容量，然后固定数量的内存空间会被分配给程序，这些内存空间通常称为栈空间。栈空间用于存放上面计算所需的所有的原始数据类型。之所以称之为栈空间，是因为变量的进出遵循FIFO原则。

{% codeblock %}
int n; // 4 bytes
int x[4]; // 4 * 4 bytes
double m; // 8 bytes
{% endcodeblock %}

编译器可以简单的确定总共需要 4 + 4 * 4 + 8 = 28 bytes。

{% blockquote %}
每一个int型变量或double型变量占用几个字节和操作系统，硬件平台相关，实际情况应具体情况具体分析
{% endblockquote %}

编译器请求在栈空间分配特定数量的内存空间，用于存放变量。在上面的示例代码中，编译器明确的知道它所需要的内存空间的大小和地址。无论我们对变量x进行何种操作， 基本上都会被翻译为对内存空间地址为xxxx的内存进行操作。

每个变量所代表的都是一个内存地址，内存地址指向的内存空间会存储变量对应的值。我们可以把变量当做一个地址，专门用于寻找对应内存地址的内存空间。

当一个函数调用另外一个函数的时候，每一个函数被调用时都会获得自身的栈块，栈块保存着这个函数自身的所有本地变量和一个程序计数器，程序计数器保存着执行器的位置。当函数运行结束后，对应的内存块会被释放，用作其他用途。

### 动态内存分配

